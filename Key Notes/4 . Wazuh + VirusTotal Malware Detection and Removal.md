# 🛡️ Wazuh + VirusTotal Malware Detection and Removal

This guide demonstrates how to integrate **Wazuh** with **VirusTotal** to detect and remove malware using the **File Integrity Monitoring (FIM)** module and an **active response script**. It includes setup for both **Ubuntu** and **Windows** endpoints.

---

## 🧱 Infrastructure

| Endpoint  | Description |
|-----------|-------------|
| Ubuntu 22.04 | Linux endpoint that downloads malicious files. Wazuh removes it upon VirusTotal flag. |
| Windows 11  | Windows endpoint that downloads malicious files. Wazuh removes it upon VirusTotal flag. |

---

## 🐧 Ubuntu Configuration

### 🔧 Enable Real-time Directory Monitoring

Edit `/var/ossec/etc/ossec.conf` on the Ubuntu endpoint:

```xml
<syscheck>
  <disabled>no</disabled>
  <directories realtime="yes">/root</directories>
</syscheck>
```

### 📦 Install Required Package

```bash
sudo apt update
sudo apt -y install jq
```

### 🧹 Create Active Response Script

Path: `/var/ossec/active-response/bin/remove-threat.sh`

```bash
#!/bin/bash

LOCAL=`dirname $0`;
cd $LOCAL
cd ../

PWD=`pwd`

read INPUT_JSON
FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
COMMAND=$(echo $INPUT_JSON | jq -r .command)
LOG_FILE="${PWD}/../logs/active-responses.log"

if [ ${COMMAND} = "add" ]; then
  printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys", "parameters":{"keys":[]}}\n'
  read RESPONSE
  COMMAND2=$(echo $RESPONSE | jq -r .command)
  if [ ${COMMAND2} != "continue" ]; then
    echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Remove threat active response aborted" >> ${LOG_FILE}
    exit 0;
  fi
fi

rm -f $FILENAME
if [ $? -eq 0 ]; then
  echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
else
  echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
fi

exit 0
```

### 🔐 Set Permissions

```bash
sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh
```

### 🔄 Restart Wazuh Agent

```bash
sudo systemctl restart wazuh-agent
```

---

## ⚙️ Wazuh Server Configuration

### 🧯 FIM Rule (local_rules.xml)

Path: `/var/ossec/etc/rules/local_rules.xml`

```xml
<group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
  <rule id="100200" level="7">
    <if_sid>550</if_sid>
    <field name="file">/root</field>
    <description>File modified in /root directory.</description>
  </rule>
  <rule id="100201" level="7">
    <if_sid>554</if_sid>
    <field name="file">/root</field>
    <description>File added to /root directory.</description>
  </rule>
</group>
```

### 🔌 VirusTotal Integration (ossec.conf)

```xml
<integration>
  <name>virustotal</name>
  <api_key>YOUR_VIRUS_TOTAL_API_KEY</api_key>
  <rule_id>100200,100201</rule_id>
  <alert_format>json</alert_format>
</integration>
```

### ⚔️ Active Response (ossec.conf)

```xml
<command>
  <name>remove-threat</name>
  <executable>remove-threat.sh</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<active-response>
  <disabled>no</disabled>
  <command>remove-threat</command>
  <location>local</location>
  <rules_id>87105</rules_id>
</active-response>
```

### 📢 Active Response Rule

```xml
<group name="virustotal,">
  <rule id="100092" level="12">
    <if_sid>657</if_sid>
    <match>Successfully removed threat</match>
    <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>

  <rule id="100093" level="12">
    <if_sid>657</if_sid>
    <match>Error removing threat</match>
    <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>
</group>
```

### 🔄 Restart Wazuh Manager

```bash
sudo systemctl restart wazuh-manager
```

---

## 🧪 Test (Linux)

### 🦠 Download Test Virus File

```bash
sudo curl -Lo /root/eicar.com https://secure.eicar.org/eicar.com
```

---

## 🪟 Windows Endpoint Configuration

### 📁 Modify Agent Config

Path: `C:\Program Files (x86)\ossec-agent\ossec.conf`

```xml
<syscheck>
  <disabled>no</disabled>
  <directories realtime="yes">C:\Users\<USER_NAME>\Downloads</directories>
</syscheck>
```

### 🐍 Install Python + PyInstaller

1. Install Python from [python.org](https://www.python.org/)
2. Select:
   - ✅ Install for all users
   - ✅ Add Python to PATH
3. Open PowerShell (Admin):

```powershell
pip install pyinstaller
pyinstaller --version
```

### 🧹 Python Active Response Script (remove-threat.py)

Convert this script using PyInstaller:

```python
import os
import sys
import json
import datetime

LOG_FILE = "C:\\Program Files (x86)\\ossec-agent\\active-response\\active-responses.log"

def write_log(message):
    with open(LOG_FILE, "a") as log:
        log.write(f"{datetime.datetime.now()} remove-threat: {message}\n")

def main():
    try:
        alert = json.loads(sys.stdin.read())
        command = alert.get("command", "")
        filename = alert["parameters"]["alert"]["data"]["virustotal"]["source"]["file"]
    except Exception as e:
        write_log(f"Error parsing input: {str(e)}")
        sys.exit(1)

    if command != "add":
        write_log(f"Ignoring command: {command}")
        return

    try:
        os.remove(filename)
        write_log(f"Successfully removed {filename}")
    except Exception as e:
        write_log(f"Error removing file {filename}: {str(e)}")

if __name__ == "__main__":
    main()
```

Compile to `.exe`:

```powershell
pyinstaller --onefile remove-threat.py
```

Move the `.exe` to `C:\Program Files (x86)\ossec-agent\active-response\`.

---

## 📊 Visualization in Wazuh Dashboard

Go to `Threat Hunting` and use filters:

```kibana
rule.id: is one of 553,100092,87105,100201
```

Look for alert: **Remove malware on Linux alert**

---

## 📝 Notes

- VirusTotal free API: max 4 requests/minute.
- For high-frequency scanning, consider a premium API.
- Extend to monitor other sensitive directories as needed.
